<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>高级备份工具</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 1400px;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #343a40;
      color: white;
      font-weight: bold;
    }
    .path-pair {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .path-input {
      flex: 1;
    }
    .log-container {
      height: 500px;
      overflow-y: auto;
      background-color: #2d2d2d;
      color: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
    }
    .queue-item {
      background-color: #e9ecef;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }
    .btn-remove {
      padding: 2px 8px;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">高级备份工具</h1>
    
    <div class="row">
      <!-- 左侧路径配置区 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            备份路径配置
          </div>
          <div class="card-body">
            <div id="pathPairs">
              <div class="path-pair">
                <div class="path-input">
                  <label class="form-label">源路径 (输入)</label>
                  <input type="text" class="form-control source-path" placeholder="/host/path/to/source">
                </div>
                <div class="path-input">
                  <label class="form-label">目标路径 (输出)</label>
                  <input type="text" class="form-control dest-path" placeholder="/data/path/to/destination">
                </div>
                <button type="button" class="btn btn-danger btn-remove" onclick="removePathPair(this)">-</button>
              </div>
            </div>
            <button type="button" class="btn btn-secondary mt-3" onclick="addPathPair()">+ 添加路径对</button>
            <button type="button" class="btn btn-primary mt-3 ms-2" onclick="addTasks()">添加所有任务到队列</button>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">
            任务队列
          </div>
          <div class="card-body">
            <ul id="queue" class="list-unstyled"></ul>
          </div>
        </div>
      </div>

      <!-- 右侧日志区 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            运行日志
          </div>
          <div class="card-body">
            <div id="log" class="log-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 添加新的路径对
    function addPathPair() {
      const container = document.getElementById('pathPairs');
      const newPair = document.createElement('div');
      newPair.className = 'path-pair';
      newPair.innerHTML = `
        <div class="path-input">
          <label class="form-label">源路径 (输入)</label>
          <input type="text" class="form-control source-path" placeholder="/host/path/to/source">
        </div>
        <div class="path-input">
          <label class="form-label">目标路径 (输出)</label>
          <input type="text" class="form-control dest-path" placeholder="/data/path/to/destination">
        </div>
        <button type="button" class="btn btn-danger btn-remove" onclick="removePathPair(this)">-</button>
      `;
      container.appendChild(newPair);
    }

    // 移除路径对
    function removePathPair(button) {
      const container = document.getElementById('pathPairs');
      const pair = button.parentElement;
      if (container.children.length > 1) {
        container.removeChild(pair);
      } else {
        alert('至少保留一个路径对');
      }
    }

    // 添加所有任务到队列
    function addTasks() {
      const pairs = document.getElementsByClassName('path-pair');
      const tasks = [];
      
      for (let i = 0; i < pairs.length; i++) {
        const source = pairs[i].querySelector('.source-path').value.trim();
        const dest = pairs[i].querySelector('.dest-path').value.trim();
        
        if (!source || !dest) {
          alert('请填写完整的源路径和目标路径');
          return;
        }
        
        tasks.push({ source, dest });
      }
      
      fetch('/api/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tasks })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          // 清空输入框
          document.querySelectorAll('.source-path, .dest-path').forEach(input => {
            input.value = '';
          });
          // 刷新队列显示
          refreshQueue();
        }
      });
    }

    // 刷新队列显示
    function refreshQueue() {
      fetch('/api/queue')
        .then(response => response.json())
        .then(data => {
          const queueElement = document.getElementById('queue');
          queueElement.innerHTML = '';
          
          data.queue.forEach((task, index) => {
            const li = document.createElement('li');
            li.className = 'queue-item';
            li.innerHTML = `
              <div>
                <strong>源:</strong> ${task.source}<br>
                <strong>目标:</strong> ${task.dest}
              </div>
            `;
            queueElement.appendChild(li);
          });
        });
    }

    // 实时日志更新
    function connectLogStream() {
      const logElement = document.getElementById('log');
      const source = new EventSource('/stream');
      
      source.onmessage = function(event) {
        logElement.innerHTML += event.data + '<br>';
        logElement.scrollTop = logElement.scrollHeight;
      };
      
      source.onerror = function() {
        source.close();
        // 尝试重连
        setTimeout(connectLogStream, 3000);
      };
    }

    // 页面加载完成后初始化
    window.onload = function() {
      refreshQueue();
      connectLogStream();
    };
  </script>
</body>
</html>
